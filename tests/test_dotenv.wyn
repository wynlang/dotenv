fn Dotenv_parse(content: string) -> HashMap {
    var result = HashMap.new()
    var lines = content.split("\n")
    for line in lines {
        var trimmed = line.trim()
        if trimmed.len() == 0 { continue }
        if trimmed[0] == "#" { continue }
        var eq_pos = -1
        for i in 0..trimmed.len() {
            if trimmed[i] == "=" { eq_pos = i }
        }
        if eq_pos > 0 {
            var key = trimmed.substring(0, eq_pos).trim()
            var val = trimmed.substring(eq_pos + 1, trimmed.len()).trim()
            if val.len() >= 2 {
                if val[0] == "\"" && val[val.len() - 1] == "\"" {
                    val = val.substring(1, val.len() - 1)
                }
            }
            result.insert(key, val)
        }
    }
    return result
}

test "host" {
    // Parse .env content
    var env = Dotenv_parse("DB_HOST=localhost\nDB_PORT=5432\n# comment\nAPI_KEY=\"secret123\"\n\nDEBUG=true")
    assert_eq(env.get("DB_HOST"), "localhost")
}

test "port" {
    // Parse .env content
    var env = Dotenv_parse("DB_HOST=localhost\nDB_PORT=5432\n# comment\nAPI_KEY=\"secret123\"\n\nDEBUG=true")
    assert_eq(env.get("DB_PORT"), "5432")
}

test "quoted value" {
    // Parse .env content
    var env = Dotenv_parse("DB_HOST=localhost\nDB_PORT=5432\n# comment\nAPI_KEY=\"secret123\"\n\nDEBUG=true")
    assert_eq(env.get("API_KEY"), "secret123")
}

test "bool" {
    // Parse .env content
    var env = Dotenv_parse("DB_HOST=localhost\nDB_PORT=5432\n# comment\nAPI_KEY=\"secret123\"\n\nDEBUG=true")
    assert_eq(env.get("DEBUG"), "true")
}

test "comment skipped" {
    // Parse .env content
    var env = Dotenv_parse("DB_HOST=localhost\nDB_PORT=5432\n# comment\nAPI_KEY=\"secret123\"\n\nDEBUG=true")
    // Comments and blank lines skipped
    assert_eq(env.get("# comment"), "")
}

test "file load" {
    // Parse .env content
    var env = Dotenv_parse("DB_HOST=localhost\nDB_PORT=5432\n# comment\nAPI_KEY=\"secret123\"\n\nDEBUG=true")
    // Comments and blank lines skipped
    // File-based load
    File.write("/tmp/wyn_test.env", "NAME=Wyn\nVER=1.7")
    var loaded = Dotenv_parse(File.read("/tmp/wyn_test.env"))
    assert_eq(loaded.get("NAME"), "Wyn")
}

test "file ver" {
    // Parse .env content
    var env = Dotenv_parse("DB_HOST=localhost\nDB_PORT=5432\n# comment\nAPI_KEY=\"secret123\"\n\nDEBUG=true")
    // Comments and blank lines skipped
    // File-based load
    File.write("/tmp/wyn_test.env", "NAME=Wyn\nVER=1.7")
    var loaded = Dotenv_parse(File.read("/tmp/wyn_test.env"))
    assert_eq(loaded.get("VER"), "1.7")
}
